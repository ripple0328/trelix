#!/bin/sh
#
# Pre-push hook for SocialCircle Elixir/Phoenix project
# This hook runs additional checks before pushing to remote repository
#

echo "ğŸš€ Running pre-push checks..."

# Check if we're in the right directory
if [ ! -f "mix.exs" ]; then
    echo "âŒ Error: mix.exs not found. Are you in the project root?"
    exit 1
fi

# Check if Mix is available
if ! command -v mix >/dev/null 2>&1; then
    echo "âŒ Error: Mix is not installed or not in PATH"
    exit 1
fi

# Get the range of commits being pushed
remote="$1"
url="$2"

# Read from stdin to get the list of refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Handle delete - no checks needed
        continue
    fi
    
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch - check all commits
        range="$local_sha"
    else
        # Update - check commits between remote and local
        range="$remote_sha..$local_sha"
    fi
    
    # Get the list of commits
    commits=$(git rev-list "$range" 2>/dev/null)
    
    if [ -n "$commits" ]; then
        echo "ğŸ” Checking commits for branch $local_ref..."
        
        # Run comprehensive checks
        echo "ğŸ“‹ Running comprehensive pre-push checks..."
        
        # Run the full quality suite
        echo "ğŸ¯ Running full quality checks..."
        if ! mix quality; then
            echo "âŒ Quality checks failed (compile, format, credo, dialyzer, tests)"
            echo "ğŸ’¡ Run 'mix quality' locally to see detailed issues"
            exit 1
        fi
        
        # Check for dependencies issues
        echo "ğŸ“¦ Checking dependencies..."
        if ! mix deps.get --only prod; then
            echo "âŒ Dependency issues found"
            exit 1
        fi
        
        # Check if there are any TODO or FIXME comments in the diff
        echo "ğŸ“ Checking for TODO/FIXME comments in new code..."
        todo_count=$(git diff "$remote_sha..$local_sha" --name-only | xargs grep -l "TODO\|FIXME" 2>/dev/null | wc -l)
        if [ "$todo_count" -gt 0 ]; then
            echo "âš ï¸  Warning: Found TODO/FIXME comments in the code being pushed"
            echo "ğŸ’¡ Consider resolving these before pushing to production"
            # Don't fail on TODO/FIXME, just warn
        fi
        
        echo "âœ… All pre-push checks passed for $local_ref!"
    fi
done

echo "ğŸ‰ Ready to push!"
exit 0